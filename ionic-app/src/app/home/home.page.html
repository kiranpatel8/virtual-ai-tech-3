<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <div class="logo-container">
       <!-- <ion-icon name="wifi" class="logo-icon"></ion-icon> -->
        <img src="assets/images/frontier.jpg" alt="Company Logo" class="logo-image">
      </div>
    </ion-buttons>
    <ion-title>
      Virtual AI Technician -2
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="checkApiHealth()">
        <ion-icon 
          name="pulse" 
          [color]="apiHealthy ? 'success' : 'danger'">
        </ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Header Section -->
  <div class="header-section">
    <ion-icon name="camera" class="main-icon"></ion-icon>
    <h2>Frontier Self-Service Agent</h2>
    <p>Take a photo or select an image to auto diagnose internet issues</p>
  </div>

  <!-- Display boolean 
  <p>API Healthy: {{ apiHealthy }}</p>
  <p>Health: {{ healthStatus }}</p>
  -->


  <!-- API Status -->
  <ion-card *ngIf="!apiHealthy" color="warning">
    <ion-card-content>
      <ion-icon name="warning" slot="start"></ion-icon>
      API Service Unavailable - Make sure the Python service is running
    </ion-card-content>
  </ion-card>

  <!-- Camera Controls -->
  <div class="camera-controls">
    <ion-button 
      expand="block" 
      fill="solid" 
      (click)="takePicture()"
      [disabled]="isLoading">
      <ion-icon name="camera" slot="start"></ion-icon>
      Take Picture
    </ion-button>

    <ion-button 
      expand="block" 
      fill="outline" 
      (click)="selectFromGallery()"
      [disabled]="isLoading">
      <ion-icon name="images" slot="start"></ion-icon>
      Select from Gallery
    </ion-button>
  </div>

  <!-- Captured Image -->
  <ion-card *ngIf="capturedImage" class="image-card">
    <img [src]="capturedImage" alt="Captured device image" />
    
    <ion-card-content>
      <ion-button 
        fill="clear" 
        color="danger" 
        (click)="clearImage()"
        class="clear-button">
        <ion-icon name="trash" slot="start"></ion-icon>
        Clear Image
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Loading State -->
  <ion-card *ngIf="isLoading" class="loading-card">
    <ion-card-content class="ion-text-center">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Analyzing device...</p>
    </ion-card-content>
  </ion-card>

  <!-- Identification Results -->
  <ion-card *ngIf="identificationResult && !isLoading" class="results-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="analytics-outline"></ion-icon>
        Diagnosis Results
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <!-- Success Results -->
      <div *ngIf="identificationResult.status === 'success'">
        <!-- Problem description -->
        <div class="top-prediction" *ngIf="identificationResult.problem_detected; else noProblem">
          <h3>Problem Detected</h3>
          <div class="prediction-item main-prediction">
            <div class="prediction-info">
              <ion-icon name="hardware-chip" color="primary"></ion-icon>
              <span class="device-name">{{ identificationResult.problem_description }}</span>
            </div>
          </div> 
        </div>
        
        <!-- Dispatch note -->
        <div class="top-prediction" *ngIf="identificationResult.problem_detected">
          <h3>Resolution</h3>
          <div class="prediction-item main-prediction">
            <div class="prediction-info">
              <ion-icon name="hardware-chip" color="primary"></ion-icon>
              <span class="device-name">{{ identificationResult.dispatch_note }}</span>
            </div>
          </div>
        </div>

        <ng-template #noProblem>
          <div class="no-problem">
            <h3>No problem detected</h3>
            <p>If you still have issues, try retaking the photo or check connections.</p>
          </div>
        </ng-template>

        <!-- All Predictions
        <div class="all-predictions" *ngIf="identificationResult.predictions && identificationResult.predictions.length > 1">
          <h4>Alternative Predictions</h4>
          <div 
            *ngFor="let prediction of identificationResult.predictions.slice(1, 4)" 
            class="prediction-item">
            <div class="prediction-info">
              <ion-icon name="radio" color="medium"></ion-icon>
              <span class="device-name">{{ prediction.label }}</span>
            </div>
            <ion-badge 
              [color]="getConfidenceColor(prediction.score)"
              fill="outline"
              class="confidence-badge">
              {{ getConfidencePercent(prediction.score) }}
            </ion-badge>
          </div>
        </div>
      -->
      

        <!-- Metadata
        <div class="metadata">
          <ion-item lines="none">
            <ion-icon name="layers" slot="start" color="medium"></ion-icon>
            <ion-label>
              <h4>Model Used</h4>
              <p>{{ identificationResult.model_used }}</p>
            </ion-label>
          </ion-item>

          <ion-item lines="none">
            <ion-icon name="document" slot="start" color="medium"></ion-icon>
            <ion-label>
              <h4>File Size</h4>
              <p>{{ (identificationResult.file_size / 1024).toFixed(1) }} KB</p>
            </ion-label>
          </ion-item>
        </div>
      -->
      
      </div>

  

      <!-- Model Loading -->
      <div *ngIf="identificationResult.status === 'model_loading'" class="status-message">
        <ion-icon name="hourglass" color="warning"></ion-icon>
        <h3>Model Loading</h3>
        <p>{{ identificationResult.message }}</p>
        <p>Please wait {{ identificationResult.estimated_time }}s and try again.</p>
      </div>

      <!-- No Classification -->
      <div *ngIf="identificationResult.status === 'no_classification'" class="status-message">
        <ion-icon name="help-circle" color="medium"></ion-icon>
        <h3>Unable to Classify</h3>
        <p>{{ identificationResult.message }}</p>
        <p>Try taking a clearer photo or a different angle.</p>
      </div>

      <!-- Error Status -->
      <div *ngIf="identificationResult.status === 'error'" class="status-message">
        <ion-icon name="warning" color="danger"></ion-icon>
        <h3>Classification Error</h3>
        <p>{{ identificationResult.message }}</p>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Instructions -->
  <ion-card *ngIf="!capturedImage && !isLoading" class="instructions-card">
    <ion-card-content>
      <h3><ion-icon name="information-circle" slot="start"></ion-icon>How to use</h3>
      <ion-list>
        <ion-item lines="none">
          <ion-icon name="camera" slot="start" color="primary"></ion-icon>
          <ion-label class="ion-text-wrap">
            Take a clear photo of the telecom device
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-icon name="sunny" slot="start" color="warning"></ion-icon>
          <ion-label class="ion-text-wrap">
            Ensure good lighting and the device is clearly visible
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-icon name="resize" slot="start" color="success"></ion-icon>
          <ion-label class="ion-text-wrap">
            Fill the frame with the device for better accuracy
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Hidden file input for preserving filename -->
  <input 
    type="file" 
    #fileInput 
    accept="image/*" 
    style="display: none;" 
    (change)="onFileSelected($event)" />
</ion-content>
